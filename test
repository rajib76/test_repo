import os
from typing import Optional, Dict, List
from pydantic import BaseModel
from openai import OpenAI

# âœ… Initialize client using OpenAI SDK v1 (latest)
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# âœ… Define your Pydantic form
class IssueModel(BaseModel):
    issue_type: Optional[str]
    device_id: Optional[str]
    severity: Optional[str]
    description: Optional[str]

# âœ… System prompt defines assistant behavior and schema context
SYSTEM_PROMPT_TEMPLATE = """
You are a helpful assistant that gathers missing information to fill out a form.

Here are the fields in the form:
{schema}

Ask one question at a time to collect the missing information.
Don't ask about fields that have already been filled.
Don't repeat yourself.
"""

# âœ… Utility: format model schema
def get_schema(model: BaseModel) -> str:
    return "\n".join(f"{field}: {type_.__name__}" for field, type_ in model.__annotations__.items())

# âœ… Utility: extract filled values
def get_known_values(model_data: Dict[str, Optional[str]]) -> str:
    return "\n".join(f"{k}: {v}" for k, v in model_data.items() if v is not None)

# âœ… Utility: get missing fields
def get_missing_fields(model_data: Dict[str, Optional[str]]) -> List[str]:
    return [k for k, v in model_data.items() if v is None]

# âœ… Main conversation loop
def main():
    print("ðŸ¤– Let's complete the issue report form.")
    
    model_data: Dict[str, Optional[str]] = {field: None for field in IssueModel.__fields__}

    # âœ… Initialize message history
    messages = [
        {
            "role": "system",
            "content": SYSTEM_PROMPT_TEMPLATE.format(schema=get_schema(IssueModel))
        }
    ]

    while True:
        if all(value is not None for value in model_data.values()):
            print("\nâœ… All information has been collected!\n")
            print("ðŸ“‹ Final Completed Form:")
            print("-" * 40)
            for field, value in model_data.items():
                print(f"{field.title().replace('_', ' ')}: {value}")
            print("-" * 40)
            print("ðŸŽ‰ Thank you! The form is now complete.")
            break

        # âœ… Provide current form state
        user_prompt = f"""
Current values:
{get_known_values(model_data) or 'None'}

Missing fields: {', '.join(get_missing_fields(model_data))}

Please ask the next best question to fill in the missing data.
"""
        messages.append({"role": "user", "content": user_prompt})

        # âœ… Chat with GPT-4o (OpenAI SDK v1 call)
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=messages,
            temperature=0.5
        )

        assistant_msg = response.choices[0].message.content.strip()
        messages.append({"role": "assistant", "content": assistant_msg})

        print("\nðŸ¤–", assistant_msg)
        user_input = input("You: ").strip()
        messages.append({"role": "user", "content": user_input})

        # âœ… Assign input to the next missing field
        for field in model_data:
            if model_data[field] is None:
                model_data[field] = user_input
                break

if __name__ == "__main__":
    main()
